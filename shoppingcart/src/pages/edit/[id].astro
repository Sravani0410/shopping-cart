---
import BaseLayout from "@/layouts/BaseLayout.astro";
import type { Links } from "@/types/Links";

const { id } = Astro.params;

const req = await fetch(`${Astro.url.origin}/api/getLink.json?${id}`);
if (!req.ok) {
  throw new Error("Failed to fetch link data");
}
const { data }: { data: Links[] } = await req.json();
// console.log("data111======>", data);
const editedData = data.find((item) => item._id === id);
if (!editedData) {
  throw new Error(`Link with id ${id} not found`);
}
// console.log("data111======>", editedData);
// editedData.description = editedData.description.replace(/(?:\r\n|\r|\n)/g, '\n');
---
<BaseLayout>
  <form id="add-form" class="grid gap-4">
    <div class="grid">
      <label for="title">Name</label>
      <input required type="text" name="name" id="title" value={editedData.name}/>
    </div>
    <div class="grid">
      <label>Description</label>
      <textarea required name="description" maxlength="160" id="description">
       {editedData.description.replace(/(?:\r\n|\r|\n)/g, '\n')}
      </textarea>
    </div>
    <div class="grid">
      <label for="price">Price </label>
      <input type="number" name="price" id="price" value={editedData.price} /> 
    </div>
    <flex class="gap-6 flex file:flex-wrap">
      <div class="grid max-w-fit">
        <button class="bg-blue-500 text-blue-50 px-6 py-2 max-w-fit" type="submit">Update Product</button>
      </div>
    </flex>
  </form>
</BaseLayout>

<script define:vars={{id}}>
  document.addEventListener('DOMContentLoaded', () => {
    const addForm = document.querySelector("#add-form");
    addForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(addForm);
      const values = Object.fromEntries(formData);
      console.log("values", values, JSON.stringify(values));
      try {
        const res = await fetch(`https://shopping-cart-backend-three.vercel.app/api/products/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(values),
        });
        console.log("res", res);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const responseJson = await res.json();
        console.log("responseJson", responseJson);
        window.location.href = "/";
      } catch (err) {
        console.error(err);
      }
    });
  });
</script>

